#!/usr/bin/env python3

import subprocess

def undefined_cites():
    checkcites = subprocess.getoutput("checkcites -U *.aux")
    start = checkcites.index('Undefined references in your TeX document:')
    return [x[3:] for x in checkcites[start:].split('\n')[1:]]


base = 'bibtool --print.align.key=0 --print.line.length=10000 ~/lib/zotero.bib'
undef = undefined_cites()
cmd = base + ''.join(' -X ' + ck for ck in undef)
status, bibtex = subprocess.getstatusoutput(cmd)
if status == 1:
    print('bibtool returned an error:\n', bibtex)
    exit(1)

with open('references.bib', 'a') as f:
    f.write('\n\n')
    f.write(bibtex)

n_found = bibtex.count('\n@')
print('Added', n_found, 'references to references.bib')

if n_found != len(undef):
    print('Some missing references remain:')
    for ck in undefined_cites():
        print('  ', ck)